<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Dashboard - MediCare</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- 1. THEME VARIABLES --- */
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338ca;
            --secondary: #EC4899;
            --background: #f3f4f6;
            --surface: #ffffff;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
        }

        [data-theme="dark"] {
            --background: #111827;
            --surface: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --border: #374151;
        }

        /* --- 2. GLOBAL RESET --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; transition: all 0.3s ease; }
        body { background-color: var(--background); color: var(--text-primary); }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }

        /* --- 3. HEADER --- */
        .header { background: var(--surface); padding: 1rem 0; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 100; }
        .header-inner { display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 10px; text-decoration: none; font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        
        /* Buttons */
        .btn { padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; border: none; font-size: 0.9rem; font-weight: 500; display: inline-flex; align-items: center; gap: 5px; text-decoration: none; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); }
        .btn-outline:hover { border-color: var(--danger); color: var(--danger); }
        .theme-toggle { background: none; border: none; font-size: 1.2rem; color: var(--text-primary); cursor: pointer; padding: 5px; }

        /* --- 4. DASHBOARD GRID --- */
        .dashboard-header { margin: 40px 0 30px; display: flex; justify-content: space-between; align-items: end; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        .dashboard-title h1 { font-size: 1.8rem; margin-bottom: 5px; }
        .dashboard-title p { color: var(--text-secondary); }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: var(--surface); padding: 25px; border-radius: 12px; box-shadow: var(--shadow); border: 1px solid var(--border); display: flex; align-items: center; gap: 20px; }
        .stat-icon { width: 50px; height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .stat-info h3 { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px; font-weight: 500; }
        .stat-info strong { font-size: 1.5rem; color: var(--text-primary); }

        /* --- 5. TABLE STYLES --- */
        .table-container { background: var(--surface); border-radius: 12px; box-shadow: var(--shadow); border: 1px solid var(--border); overflow: hidden; }
        .table-header { padding: 20px; font-weight: 700; font-size: 1.1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px 20px; text-align: left; border-bottom: 1px solid var(--border); font-size: 0.95rem; }
        th { background: var(--background); color: var(--text-secondary); font-weight: 600; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: rgba(79, 70, 229, 0.02); }

        .patient-cell { display: flex; align-items: center; gap: 12px; }
        .avatar-small { width: 36px; height: 36px; background: #e0e7ff; color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.9rem; }
        
        /* Action Buttons */
        .action-btn { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.85rem; font-weight: 500; display: inline-flex; align-items: center; gap: 5px; margin-right: 5px; transition: 0.2s; }
        .btn-view { background: #eff6ff; color: var(--primary); border: 1px solid #dbeafe; }
        .btn-view:hover { background: var(--primary); color: white; border-color: var(--primary); }
        
        .btn-accept { background: #ecfdf5; color: var(--success); border: 1px solid #d1fae5; }
        .btn-accept:hover { background: var(--success); color: white; border-color: var(--success); }
        
        .btn-reject { background: #fef2f2; color: var(--danger); border: 1px solid #fee2e2; }
        .btn-reject:hover { background: var(--danger); color: white; border-color: var(--danger); }

        /* --- 6. MODAL STYLES --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(4px); }
        .modal-content { background: var(--surface); width: 90%; max-width: 550px; border-radius: 16px; overflow: hidden; animation: slideUp 0.3s ease; border: 1px solid var(--border); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        
        .modal-header { padding: 20px 25px; background: var(--primary); color: white; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { font-size: 1.1rem; margin: 0; display: flex; align-items: center; gap: 10px; }
        .modal-body { padding: 25px; }
        
        .profile-hero { display: flex; align-items: center; gap: 15px; padding-bottom: 20px; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
        .avatar-large { width: 60px; height: 60px; font-size: 1.5rem; background: #e0e7ff; color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; }
        
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .info-item label { display: block; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase; font-weight: 600; }
        .info-item div { font-weight: 500; font-size: 1rem; color: var(--text-primary); }

        /* FIXED: Alert Box Styling for Light/Dark Modes */
        .alert-box { padding: 12px; border-radius: 8px; font-size: 0.9rem; margin-top: 5px; display: flex; align-items: start; gap: 10px; }
        
        /* Light Mode Colors */
        .alert-danger { background: #fef2f2; color: #991b1b; border: 1px solid #fee2e2; }
        .alert-safe { background: #ecfdf5; color: #065f46; border: 1px solid #d1fae5; }

        /* Dark Mode Colors (Inverted for readability) */
        [data-theme="dark"] .alert-danger { background: rgba(127, 29, 29, 0.2); color: #fca5a5; border-color: rgba(127, 29, 29, 0.5); }
        [data-theme="dark"] .alert-safe { background: rgba(6, 78, 59, 0.2); color: #6ee7b7; border-color: rgba(6, 78, 59, 0.5); }

        .medical-notes { background: var(--background); padding: 15px; border-radius: 8px; font-size: 0.95rem; line-height: 1.5; color: var(--text-primary); border: 1px solid var(--border); }

        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

    <header class="header">
        <div class="container">
            <div class="header-inner">
                <a href="index.html" class="logo"><i class="fas fa-heart-pulse"></i> MediCare</a>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <button class="theme-toggle" id="themeToggle"><i class="fas fa-moon"></i></button>
                    <button onclick="logout()" class="btn btn-outline"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="dashboard-header">
            <div class="dashboard-title">
                <h1>Doctor Dashboard</h1>
                <p>Manage appointments and review patient profiles</p>
            </div>
            <div class="stat-card" style="padding: 10px 20px; height: auto;">
                <div class="stat-icon" style="width: 40px; height: 40px; font-size: 1.2rem; background: #e0e7ff; color: var(--primary);">
                    <i class="fas fa-user-md"></i>
                </div>
                <div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">Logged in as</div>
                    <strong id="doc-name" style="font-size: 1rem;">Dr. ...</strong>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon" style="background: #d1fae5; color: var(--success);"><i class="fas fa-calendar-check"></i></div>
                <div class="stat-info"><h3>Today's Appointments</h3><strong id="today-count">0</strong></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: #fef3c7; color: var(--warning);"><i class="fas fa-clock"></i></div>
                <div class="stat-info"><h3>Pending Requests</h3><strong id="pending-count">0</strong></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: #e0e7ff; color: var(--primary);"><i class="fas fa-users"></i></div>
                <div class="stat-info"><h3>Total Patients</h3><strong>12</strong></div>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <span>Recent Requests</span>
                <button class="btn btn-outline" style="font-size: 0.8rem;"><i class="fas fa-filter"></i> Filter</button>
            </div>
            <table id="app-table">
                <thead>
                    <tr>
                        <th>Patient Name</th>
                        <th>Schedule</th>
                        <th>Problem / Notes</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <tr><td colspan="5" style="text-align:center; padding:40px; color: var(--text-secondary);">
                        <i class="fas fa-spinner fa-spin"></i> Loading data...
                    </td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal-overlay" id="patient-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-medical-alt"></i> Patient Medical Profile</h3>
                <button onclick="closeModal()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer; opacity:0.8;">&times;</button>
            </div>
            <div class="modal-body">
                <div class="profile-hero">
                    <div class="avatar-large" id="m-avatar">U</div>
                    <div>
                        <h2 id="m-name" style="font-size: 1.25rem; margin-bottom: 2px;">Unknown</h2>
                        <span id="m-email" style="color:var(--text-secondary); font-size: 0.9rem;">email@example.com</span>
                    </div>
                </div>

                <div class="info-grid">
                    <div class="info-item">
                        <label>Date of Birth</label>
                        <div id="m-dob">--</div>
                    </div>
                    <div class="info-item">
                        <label>Blood Group</label>
                        <div id="m-blood" style="color:var(--primary);">--</div>
                    </div>
                    <div class="info-item" style="grid-column: 1 / -1;">
                        <label>Address</label>
                        <div id="m-address">--</div>
                    </div>
                </div>

                <div class="info-item" style="margin-bottom: 20px;">
                    <label>Allergies & Alerts</label>
                    <div id="m-allergies" class="alert-box alert-safe">
                        <i class="fas fa-check-circle"></i> No known allergies listed.
                    </div>
                </div>

                <div class="info-item">
                    <label>Medical History</label>
                    <div id="m-history" class="medical-notes">
                        No medical history provided.
                    </div>
                </div>

                <div style="margin-top:25px; text-align:right;">
                    <button onclick="closeModal()" class="btn btn-outline" style="padding: 8px 20px;">Close Profile</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_APPS = 'http://127.0.0.1:8000/api/appointments/';
        let allAppointments = [];

        // --- THEME LOGIC ---
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = themeToggle.querySelector('i');
        const savedTheme = localStorage.getItem('theme') || 'light';
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            themeIcon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }
        setTheme(savedTheme);
        themeToggle.addEventListener('click', () => {
            const current = document.documentElement.getAttribute('data-theme');
            setTheme(current === 'dark' ? 'light' : 'dark');
        });

        // --- LOAD DATA ---
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('access_token');
            const user = JSON.parse(localStorage.getItem('user'));
            
            if(!token || user.role !== 'doctor') {
                window.location.href = 'login.html';
                return;
            }
            document.getElementById('doc-name').textContent = `Dr. ${user.first_name} ${user.last_name}`;

            try {
                const res = await fetch(API_APPS, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                allAppointments = data;
                renderTable(data);
                updateStats(data);
            } catch (err) { 
                console.error(err);
                document.getElementById('table-body').innerHTML = `<tr><td colspan="5" style="text-align:center; color:red;">Error loading data. Is server running?</td></tr>`;
            }
        });

        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            if(data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:30px;">No appointments found.</td></tr>`;
                return;
            }

            data.forEach(app => {
                const p = app.patient_details || {};
                const name = `${p.first_name} ${p.last_name}`;
                
                // Status Badges
                let statusBadge = `<span style="color:#d97706; background:#fef3c7; padding:4px 10px; border-radius:12px; font-size:0.8rem; font-weight:600;">Pending</span>`;
                if(app.status === 'confirmed') statusBadge = `<span style="color:#059669; background:#d1fae5; padding:4px 10px; border-radius:12px; font-size:0.8rem; font-weight:600;">Confirmed</span>`;
                if(app.status === 'cancelled') statusBadge = `<span style="color:#dc2626; background:#fee2e2; padding:4px 10px; border-radius:12px; font-size:0.8rem; font-weight:600;">Cancelled</span>`;

                const row = `
                    <tr>
                        <td>
                            <div class="patient-cell">
                                <div class="avatar-small">${name[0]}</div>
                                <div>
                                    <div style="font-weight:600;">${name}</div>
                                    <div style="font-size:0.8rem; color:var(--text-secondary);">${p.email}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div style="font-weight:500;">${app.date}</div>
                            <div style="font-size:0.85rem; color:var(--primary); font-weight:600;">${app.time}</div>
                        </td>
                        <td style="color:var(--text-secondary); max-width:200px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                            ${app.notes || 'No notes provided'}
                        </td>
                        <td>${statusBadge}</td>
                        <td>
                            <button onclick="viewPatient(${app.id})" class="action-btn btn-view" title="View Profile"><i class="fas fa-file-medical"></i> Profile</button>
                            ${app.status === 'pending' ? `
                               <button onclick="updateStatus(${app.id}, 'confirmed')" class="action-btn btn-accept" title="Accept"><i class="fas fa-check"></i></button>
                               <button onclick="updateStatus(${app.id}, 'cancelled')" class="action-btn btn-reject" title="Reject"><i class="fas fa-times"></i></button>
                            ` : ''}
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function updateStats(data) {
            const today = new Date().toISOString().split('T')[0];
            const todayCount = data.filter(a => a.date === today).length;
            const pendingCount = data.filter(a => a.status === 'pending').length;
            
            document.getElementById('today-count').textContent = todayCount;
            document.getElementById('pending-count').textContent = pendingCount;
        }

        // --- MODAL LOGIC (VIEW PATIENT) ---
        function viewPatient(appId) {
            const app = allAppointments.find(a => a.id === appId);
            if(!app || !app.patient_details) return;

            const p = app.patient_details;
            const profile = p.profile || {}; // Safe access

            // Fill Data
            document.getElementById('m-name').textContent = `${p.first_name} ${p.last_name}`;
            document.getElementById('m-email').textContent = p.email;
            document.getElementById('m-avatar').textContent = (p.first_name[0] || 'U').toUpperCase();
            
            document.getElementById('m-dob').textContent = profile.date_of_birth || 'Not provided';
            document.getElementById('m-blood').textContent = profile.blood_group || '--';
            document.getElementById('m-address').textContent = profile.address || 'Not provided';
            
            const allergyBox = document.getElementById('m-allergies');
            if(profile.allergies) {
                allergyBox.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${profile.allergies}`;
                allergyBox.className = 'alert-box alert-danger';
            } else {
                allergyBox.innerHTML = `<i class="fas fa-check-circle"></i> No known allergies listed.`;
                allergyBox.className = 'alert-box alert-safe';
            }

            document.getElementById('m-history').textContent = profile.medical_history || 'No medical history provided.';

            // Show Modal
            document.getElementById('patient-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('patient-modal').style.display = 'none';
        }

        // Close modal if clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('patient-modal');
            if (event.target == modal) {
                closeModal();
            }
        }
        // --- UPDATE APPOINTMENT STATUS ---
        async function updateStatus(appId, newStatus) {
            const btn = event.currentTarget; // The button clicked
            const originalHTML = btn.innerHTML;
            
            // Show loading animation on button
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
            btn.disabled = true;

            const token = localStorage.getItem('access_token');

            try {
                const res = await fetch(`${API_APPS}${appId}/`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                if (res.ok) {
                    // Reload data to show new status
                    const data = await (await fetch(API_APPS, { headers: { 'Authorization': `Bearer ${token}` } })).json();
                    allAppointments = data;
                    renderTable(data);
                    updateStats(data);
                } else {
                    alert("Failed to update status.");
                }
            } catch (err) {
                console.error(err);
                alert("Network error.");
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }
        function logout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>