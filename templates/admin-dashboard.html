<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - MediCare</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- 1. SHARED THEME VARIABLES --- */
        :root {
            --primary: #4F46E5;
            --background: #f3f4f6;
            --surface: #ffffff;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --danger: #ef4444;
            --success: #10b981;
            
            /* Status Colors */
            --status-pending-bg: #FEF3C7; --status-pending-text: #D97706;
            --status-confirmed-bg: #D1FAE5; --status-confirmed-text: #059669;
            --status-cancelled-bg: #FEE2E2; --status-cancelled-text: #DC2626;
        }

        [data-theme="dark"] {
            --background: #111827; --surface: #1f2937;
            --text-primary: #f9fafb; --text-secondary: #d1d5db;
            --border: #374151;
            --status-pending-bg: rgba(245,158,11,0.2); --status-pending-text: #fbbf24;
            --status-confirmed-bg: rgba(16,185,129,0.2); --status-confirmed-text: #34d399;
            --status-cancelled-bg: rgba(239,68,68,0.2); --status-cancelled-text: #f87171;
        }

        /* --- 2. GLOBAL STYLES --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--background); color: var(--text-primary); transition: all 0.3s ease; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        
        /* Header & Buttons */
        .header { background: var(--surface); padding: 1rem 0; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 100; }
        .header-inner { display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 10px; text-decoration: none; font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        .btn { padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; border: none; font-size: 0.9rem; font-weight: 500; transition: 0.2s; }
        .btn-outline { border: 1px solid var(--primary); color: var(--primary); background: transparent; }
        .btn-primary { background: var(--primary); color: white; }
        .theme-toggle { background: none; border: none; color: var(--text-primary); font-size: 1.2rem; cursor: pointer; }

        /* Dashboard Components */
        .dashboard-header { margin: 40px 0 30px; display: flex; justify-content: space-between; align-items: end; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: var(--surface); padding: 24px; border-radius: 12px; border: 1px solid var(--border); display: flex; align-items: center; gap: 20px; box-shadow: var(--shadow); }
        .stat-icon { width: 50px; height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }

        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--border); }
        .tab-btn { padding: 10px 20px; background: none; border: none; color: var(--text-secondary); cursor: pointer; font-weight: 600; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

        /* Tables */
        .table-container { background: var(--surface); border-radius: 12px; border: 1px solid var(--border); overflow-x: auto; box-shadow: var(--shadow); }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 15px 20px; text-align: left; border-bottom: 1px solid var(--border); font-size: 0.95rem; }
        th { background: var(--background); color: var(--text-secondary); font-weight: 600; text-transform: uppercase; font-size: 0.8rem; }
        
        /* Badges & Actions */
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; text-transform: capitalize; }
        .role-doctor { background: #e0e7ff; color: #4338ca; }
        .role-patient { background: #d1fae5; color: #059669; }
        .role-admin { background: #fee2e2; color: #dc2626; }
        
        .status-pending { background: var(--status-pending-bg); color: var(--status-pending-text); }
        .status-confirmed { background: var(--status-confirmed-bg); color: var(--status-confirmed-text); }
        .status-cancelled { background: var(--status-cancelled-bg); color: var(--status-cancelled-text); }

        .action-btn { background: none; border: none; cursor: pointer; padding: 5px; font-size: 1.1rem; transition: transform 0.2s; }
        .btn-edit { color: var(--primary); }
        .btn-delete { color: var(--danger); }
        .action-btn:hover { transform: scale(1.2); }

        /* --- EDIT MODAL STYLES --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 2000;
        }
        .modal-content {
            background: var(--surface); padding: 2rem; border-radius: 12px; width: 90%; max-width: 500px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .form-grid { display: grid; gap: 15px; margin-top: 20px; }
        .form-group label { display: block; margin-bottom: 5px; color: var(--text-secondary); font-size: 0.9rem; }
        .form-input { 
            width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; 
            background: var(--background); color: var(--text-primary); 
        }
        .checkbox-group { display: flex; align-items: center; gap: 10px; padding: 10px 0; }
        .checkbox-group input { width: 20px; height: 20px; }

    </style>
</head>
<body>

    <header class="header">
        <div class="container">
            <div class="header-inner">
                <a href="index.html" class="logo"><i class="fas fa-heart-pulse"></i> MediCare <span style="font-size: 0.8rem; background: var(--primary); color: white; padding: 2px 6px; border-radius: 4px; margin-left: 5px;">ADMIN</span></a>
                <div class="header-controls">
                    <button class="theme-toggle" id="themeToggle"><i class="fas fa-moon"></i></button>
                    <button onclick="logout()" class="btn btn-outline" style="border-color: var(--danger); color: var(--danger);">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="dashboard-header">
            <h1>Admin Overview</h1>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon" style="background: #e0e7ff; color: #4F46E5;"><i class="fas fa-users"></i></div>
                <div><h2 id="total-users">0</h2><span>Total Users</span></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: #d1fae5; color: #059669;"><i class="fas fa-user-md"></i></div>
                <div><h2 id="total-doctors">0</h2><span>Doctors</span></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: #fef3c7; color: #d97706;"><i class="fas fa-calendar-check"></i></div>
                <div><h2 id="total-apps">0</h2><span>Appointments</span></div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('users')">Manage Users</button>
            <button class="tab-btn" onclick="switchTab('appointments')">All Appointments</button>
        </div>

        <div id="view-users" class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>User Info</th>
                        <th>Role</th>
                        <th>Details</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="users-table-body"></tbody>
            </table>
        </div>

        <div id="view-appointments" class="table-container" style="display: none;">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Doctor</th>
                        <th>Patient</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="apps-table-body"></tbody>
            </table>
        </div>
    </div>

    <div id="edit-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Edit User</h2>
            <form id="edit-form" class="form-grid">
                <input type="hidden" id="edit-id">
                
                <div class="form-group">
                    <label>First Name</label>
                    <input type="text" id="edit-fname" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>Last Name</label>
                    <input type="text" id="edit-lname" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="edit-email" class="form-input" required>
                </div>

                <div id="doctor-fields" style="display: none; border-top: 1px solid var(--border); padding-top: 15px; margin-top: 10px;">
                    <h3 style="font-size: 1rem; margin-bottom: 10px; color: var(--primary);">Doctor Details</h3>
                    <div class="form-group">
                        <label>Specialization</label>
                        <input type="text" id="edit-spec" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Consultation Fee ($)</label>
                        <input type="number" id="edit-fee" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Experience (Years)</label>
                        <input type="number" id="edit-exp" class="form-input">
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="edit-verified">
                        <label for="edit-verified" style="margin:0; font-weight:600; cursor:pointer;">Verified Doctor</label>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button type="button" onclick="closeModal()" class="btn btn-outline" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8000/api';
        let allUsers = []; // Store users for easy access

        // --- THEME ---
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = themeToggle.querySelector('i');
        const savedTheme = localStorage.getItem('theme') || 'light';
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            themeIcon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }
        setTheme(savedTheme);
        themeToggle.addEventListener('click', () => setTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'));

        // --- LOAD DATA ---
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('access_token');
            const user = JSON.parse(localStorage.getItem('user'));
            if (!token || user.role !== 'admin') {
                window.location.href = 'login.html';
                return;
            }
            await loadUsers(token);
            await loadAppointments(token);
        });

        async function loadUsers(token) {
            try {
                const res = await fetch(`${API_BASE}/users/`, { headers: { 'Authorization': `Bearer ${token}` } });
                allUsers = await res.json();
                renderUsers(allUsers);
            } catch (err) { console.error(err); }
        }

        function renderUsers(users) {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '';
            let docCount = 0;

            users.forEach(u => {
                if(u.role === 'doctor') docCount++;
                
                // Extra details display
                let details = '<span style="color:var(--text-secondary);">-</span>';
                let verifiedBadge = '';
                
                if (u.role === 'doctor') {
                    details = `<small>${u.specialization || 'N/A'}</small>`;
                    if (u.is_verified) verifiedBadge = '<i class="fas fa-check-circle" style="color:var(--success); margin-left:5px;" title="Verified"></i>';
                }

                const row = `
                    <tr>
                        <td>#${u.id}</td>
                        <td>
                            <strong>${u.first_name} ${u.last_name}</strong>${verifiedBadge}<br>
                            <small style="color:var(--text-secondary)">${u.email}</small>
                        </td>
                        <td><span class="badge role-${u.role}">${u.role}</span></td>
                        <td>${details}</td>
                        <td>
                            ${u.role !== 'admin' ? `
                            <button onclick="openEditModal(${u.id})" class="action-btn btn-edit" title="Edit"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteUser(${u.id})" class="action-btn btn-delete" title="Delete"><i class="fas fa-trash"></i></button>
                            ` : ''}
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            document.getElementById('total-users').textContent = users.length;
            document.getElementById('total-doctors').textContent = docCount;
        }

        async function loadAppointments(token) {
            try {
                const res = await fetch(`${API_BASE}/appointments/`, { headers: { 'Authorization': `Bearer ${token}` } });
                const apps = await res.json();
                const tbody = document.getElementById('apps-table-body');
                tbody.innerHTML = '';

                apps.forEach(app => {
                    const docName = app.doctor_details ? `Dr. ${app.doctor_details.last_name}` : 'Unknown';
                    const patName = app.patient_details ? app.patient_details.first_name : 'Unknown';
                    
                    let statusClass = 'status-pending';
                    if (app.status === 'confirmed') statusClass = 'status-confirmed';
                    if (app.status === 'cancelled') statusClass = 'status-cancelled';

                    const row = `
                        <tr>
                            <td>#${app.id}</td>
                            <td>${docName}</td>
                            <td>${patName}</td>
                            <td>${app.date}</td>
                            <td><span class="badge ${statusClass}">${app.status}</span></td>
                            <td><button onclick="deleteApp(${app.id})" class="action-btn btn-delete"><i class="fas fa-trash"></i></button></td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
                document.getElementById('total-apps').textContent = apps.length;
            } catch (err) { console.error(err); }
        }

        // --- EDIT MODAL LOGIC ---
        const modal = document.getElementById('edit-modal');
        const docFields = document.getElementById('doctor-fields');

        function openEditModal(id) {
            const user = allUsers.find(u => u.id === id);
            if(!user) return;

            document.getElementById('edit-id').value = user.id;
            document.getElementById('edit-fname').value = user.first_name;
            document.getElementById('edit-lname').value = user.last_name;
            document.getElementById('edit-email').value = user.email;

            if (user.role === 'doctor') {
                docFields.style.display = 'block';
                document.getElementById('edit-spec').value = user.specialization || '';
                document.getElementById('edit-fee').value = user.consultation_fee || '';
                document.getElementById('edit-exp').value = user.experience || '';
                document.getElementById('edit-verified').checked = user.is_verified;
            } else {
                docFields.style.display = 'none';
            }
            modal.style.display = 'flex';
        }

        function closeModal() { modal.style.display = 'none'; }
        window.onclick = function(e) { if(e.target == modal) closeModal(); }

        document.getElementById('edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const token = localStorage.getItem('access_token');

            // Build payload
            const payload = {
                first_name: document.getElementById('edit-fname').value,
                last_name: document.getElementById('edit-lname').value,
                email: document.getElementById('edit-email').value,
            };

            // Add doctor fields if visible
            if (docFields.style.display !== 'none') {
                payload.specialization = document.getElementById('edit-spec').value;
                payload.consultation_fee = document.getElementById('edit-fee').value;
                payload.experience = document.getElementById('edit-exp').value;
                payload.is_verified = document.getElementById('edit-verified').checked;
            }

            try {
                const res = await fetch(`${API_BASE}/users/${id}/`, {
                    method: 'PATCH',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    alert("User updated successfully!");
                    closeModal();
                    loadUsers(token); // Refresh table
                } else {
                    alert("Failed to update user.");
                }
            } catch(e) { alert("Network Error"); }
        });

        // --- DELETE LOGIC ---
        async function deleteUser(id) {
            if(!confirm("Delete this user?")) return;
            const token = localStorage.getItem('access_token');
            await fetch(`${API_BASE}/users/${id}/`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
            loadUsers(token);
        }

        async function deleteApp(id) {
            if(!confirm("Delete appointment?")) return;
            const token = localStorage.getItem('access_token');
            await fetch(`${API_BASE}/appointments/${id}/`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
            loadAppointments(token);
        }

        // --- TABS & LOGOUT ---
        function switchTab(t) {
            const uv = document.getElementById('view-users'), av = document.getElementById('view-appointments');
            const btns = document.querySelectorAll('.tab-btn');
            if(t === 'users') { uv.style.display='block'; av.style.display='none'; btns[0].classList.add('active'); btns[1].classList.remove('active'); }
            else { uv.style.display='none'; av.style.display='block'; btns[0].classList.remove('active'); btns[1].classList.add('active'); }
        }
        function logout() { localStorage.clear(); window.location.href='index.html'; }
    </script>
</body>
</html>